---
title: "Coronavirus Interactive Exploration"
output:
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: scroll
    theme: flatly
    navbar:
    - title: Made by Esteban Ruc√°n
      href: https://github.com/estebanrucan
      align: right
runtime: shiny
resource_files:
- datasets/coordinates.RDS
- datasets/date.RDS
- datasets/owid-covid-data.csv
- datasets/owid-covid-data.RDS
- codes/global.R
- codes/statics.RData
---

```{r setup, include=FALSE}
load(file.path('codes', 'statics.RData'))
source(file.path('codes', 'global.R'))

today <- Sys.Date() %>% with_tz('UTC')

end <- covid_data %>%
  pull(date) %>%
  max()
```

Overwatch
=======================================================================


Column {data-width=500}
-----------------------------------------------------------------------

### Total Cases per Continent Over the Time

```{r}
plot <- evolution_of_cases('2020-01-01', today) %>%
    ggplot(aes(date, total_cases, color = continent)) +
    geom_line() +
    theme_classic() +
    labs(
        x        = 'Date',
        y        = 'Total Cases'
    ) +
    guides(color = guide_legend('Continent')) 

plot %>% 
  plotly::ggplotly() %>% 
  rangeslider(.[["x"]][["layout"]][["xaxis"]][["range"]][1], .[["x"]][["layout"]][["xaxis"]][["range"]][2])
```


### Top Countries by Cases

```{r}
country_cases('2020-01-01', today) %>% 
    select(Country, Continent, `Total Cases`) %>%
    DT::datatable(rownames = FALSE)
```


Column {data-width=500}
-----------------------------------------------------------------------

### Global Accumuled Cases

```{r}
gc <- global_total_cases('2020-01-01', today) %>% 
    ggplot(aes(Date, `Accumulated Cases`)) +
    geom_col(
      color = "deepskyblue4",
      fill = "deepskyblue3", alpha = 0.7
    ) +
    labs(x = "Date", y = "Accumuled Cases") +
    scale_y_continuous(expand = c(0, 0)) +
    theme_classic()

plotly::ggplotly(gc) %>% 
  rangeslider(.[["x"]][["layout"]][["xaxis"]][["range"]][1], .[["x"]][["layout"]][["xaxis"]][["range"]][2])
```


### Top Countries by Cases per Million

```{r}
country_cases_pm('2020-01-01', today) %>% 
    select(Country, Continent, `Total Cases per Million`) %>%
    DT::datatable(rownames = FALSE)
```



Map
=======================================================================

Column {data-width=300 .sidebar}
-----------------------------------------------------------------------

```{r, fig.align='center'}
h1("\n\n\n\n\n\n\n\n")

dateRangeInput("date_range_map", strong("Date Range"), start = as.Date("2020-01-01"), end = end)

actionButton("view_map", "View")
```

```{r}
tags$footer(HTML(paste0("<footer><small><b>Updated ", time_since_last_commit, " hours ago.</b></small></footer>")), align = "left", style = "position:absolute; bottom:0; width:95%; height:50px; color: #000000; padding: 0px; background-color: transparent; z-index: 1000;")
```



Column {data-width=1000}
-----------------------------------------------------------------------

### Interactive Map


```{r, fig.height=9}

mcd <- eventReactive(input$view_map, {
  global_summary(input$date_range_map[1], input$date_range_map[2], maps)
})

renderLeaflet({
  maps2 <- mcd()

pal <- colorNumeric(palette = 'Blues',
                    domain = log10(maps2@data$total_cases))

label <- paste0(
    '<b>Country: ', maps2$location, 
    '</b><br/>- Population:', ifelse(is.na(maps2$population), 'No info', prettyNum(maps2$population, big.mark = ",")),
    '<br/>- Total Cases: ', ifelse(maps2$total_cases == 1, 0, prettyNum(maps2$total_cases, big.mark = ",")),
    '<br/>- Total Deaths: ', prettyNum(maps2$total_deaths, big.mark = ','),
    '<br/>- Positive Rate: ', ifelse(is.infinite(maps2$positivity), 'No info', paste0(prettyNum(maps2$positivity, big.mark = ','), '%')),
    '<br/>- Total Cases per Millon: ', prettyNum(maps2$cases_pm, big.mark = ","),
    '<br/>- Total Deaths per Millon: ', prettyNum(maps2$deaths_pm, big.mark = ",")
)

maps2 %>% 
    leaflet(options = leafletOptions(minZoom = 2)) %>%
    addProviderTiles('CartoDB') %>%
    addSearchOSM() %>%
    addResetMapButton() %>% 
    addPolygons(weight      = 1, 
                color       = ~ pal(log10(total_cases)), 
                fillOpacity = 1,
                popup       = ~ label,
                highlightOptions = highlightOptions(
                    weight       = 5, 
                    color        = "white",
                    bringToFront = TRUE
                ))

})
```

Country
=======================================================================

Column {data-width=300 .sidebar}
-----------------------------------------------------------------------

```{r, fig.align='center'}
h1("\n\n\n\n\n\n\n\n")

dateRangeInput("date_range_country", strong("Date Range"), start = as.Date("2020-01-01"), end = end)

selectInput("s_continent", strong("Continent"), choices = continents, selected = continents[1])

conditionalPanel(
  "input.s_continent == 'Africa'",
  selectInput("scountry1", strong("Country"),
    choices = countries_per_continent$Africa,
    selected = countries_per_continent$Africa[1]
  )
)
conditionalPanel(
  "input.s_continent == 'Asia'",
  selectInput("scountry2", strong("Country"),
    choices = countries_per_continent$Asia,
    selected = countries_per_continent$Asia[1]
  )
)
conditionalPanel(
  "input.s_continent == 'Europe'",
  selectInput("scountry3", strong("Country"),
    choices = countries_per_continent$Europe,
    selected = countries_per_continent$Europe[1]
  )
)
conditionalPanel(
  "input.s_continent == 'North America'",
  selectInput("scountry4", strong("Country"),
    choices = countries_per_continent$`North America`,
    selected = countries_per_continent$`North America`[1]
  )
)
conditionalPanel(
  "input.s_continent == 'Oceania'",
  selectInput("scountry5", strong("Country"),
    choices = countries_per_continent$Oceania,
    selected = countries_per_continent$Oceania[1]
  )
)
conditionalPanel(
  "input.s_continent == 'South America'",
  selectInput("scountry6", strong("Country"),
    choices = countries_per_continent$`South America`,
    selected = countries_per_continent$`South America`[1]
  )
)
```
```{r}
actionButton("view_country", "View")

tags$footer(HTML(paste0("<footer><small><b>Updated ", time_since_last_commit, " hours ago.</b></small></footer>")), align = "left", style = "position:absolute; bottom:0; width:95%; height:50px; color: #000000; padding: 0px; background-color: transparent; z-index: 1000;")
```


Column {data-width=290}
-----------------------------------------------------------------------

```{r}
cs <- eventReactive(input$view_country, {
  if (input$s_continent == "Africa") {
    data <- country_summary(
      start = input$date_range_country[1],
      end = input$date_range_country[2],
      country = input$scountry1
    )
  } else if (input$s_continent == "Asia") {
    data <- country_summary(
      start = input$date_range_country[1],
      end = input$date_range_country[2],
      country = input$scountry2
    )
  } else if (input$s_continent == "Europe") {
    data <- country_summary(
      start = input$date_range_country[1],
      end = input$date_range_country[2],
      country = input$scountry3
    )
  } else if (input$s_continent == "North America") {
    data <- country_summary(
      start = input$date_range_country[1],
      end = input$date_range_country[2],
      country = input$scountry4
    )
  } else if (input$s_continent == "Oceania") {
    data <- country_summary(
      start = input$date_range_country[1],
      end = input$date_range_country[2],
      country = input$scountry5
    )
  } else if (input$s_continent == "South America") {
    data <- country_summary(
      start = input$date_range_country[1],
      end = input$date_range_country[2],
      country = input$scountry6
    )
  }

  data
})
```

### $\,$

```{r}
renderValueBox({
  cs <- cs()


  valueBox(
    value = cs$interval_covid_data$location[1],
    caption = "Country",
    color = "#808080"
  ) # ,
  # icon = 'fo-virus')
})
```

### New Cases in Date Range


```{r}
renderPlotly({
  p7 <- cs()$interval_covid_data %>%
    ggplot(aes(date, new_cases)) +
    geom_col(fill = "#0f1955", alpha = 0.7) +
    theme_classic() +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(
      expand = c(0, 0),
      breaks = integer_breaks()
    ) +
    labs(x = "Date", y = "New Cases") +
    scale_x_date(date_labels = "%Y/%m/%d")
  
  p7 %>% 
    ggplotly() %>% 
      rangeslider(.[["x"]][["layout"]][["xaxis"]][["range"]][1], .[["x"]][["layout"]][["xaxis"]][["range"]][2])
})
```





### Accumuled Cases in Date Range

```{r}
renderPlotly({
  p7 <- cs()$interval_covid_data %>%
    ggplot(aes(date, total_cases)) +
    geom_col(fill = "#0f1955", alpha = 0.7) +
    theme_classic() +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(
      expand = c(0, 0),
      breaks = integer_breaks()
    ) +
    labs(x = "Date", y = "Accumulated Cases") +
    scale_x_date(date_labels = "%Y/%m/%d")
  
  p7 %>% 
    ggplotly() %>% 
      rangeslider(.[["x"]][["layout"]][["xaxis"]][["range"]][1], .[["x"]][["layout"]][["xaxis"]][["range"]][2])
})
```


### Accumuled Deaths in Date Range

```{r}
renderPlotly({
  p1 <- cs()$interval_covid_data %>%
    ggplot(aes(date, total_deaths)) +
    geom_col(fill = "#104d56", alpha = 0.7) +
    theme_classic() +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(
      expand = c(0, 0),
      breaks = integer_breaks()
    ) +
    labs(x = "Date", y = "Accumuled Deaths") +
    scale_x_date(date_labels = "%Y/%m/%d")
  
  p1 %>% 
    ggplotly() %>% 
      rangeslider(.[["x"]][["layout"]][["xaxis"]][["range"]][1], .[["x"]][["layout"]][["xaxis"]][["range"]][2])
})
```


### Accumuled Tests in Date Range

```{r}
renderPlotly({
  p2 <- cs()$interval_covid_data %>%
    ggplot(aes(date, total_tests)) +
    geom_col(fill = "#bf8cff", alpha = 0.7) +
    theme_classic() +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(
      expand = c(0, 0),
      breaks = integer_breaks()
    ) +
    labs(x = "Date", y = "Accumuled Tests") +
    scale_x_date(date_labels = "%Y/%m/%d")
  
  p2 %>% 
    ggplotly() %>% 
      rangeslider(.[["x"]][["layout"]][["xaxis"]][["range"]][1], .[["x"]][["layout"]][["xaxis"]][["range"]][2])
})
```

Column {data-width=290}
-----------------------------------------------------------------------

### $\,$

```{r}
renderValueBox({
  cs <- cs()


  valueBox(
    value = prettyNum(cs$interval_covid_data$population[1], big.mark = ","),
    caption = "Population",
    color = "#808080"
  ) # ,
  # icon = 'fo-virus')
})
```

### Active Cases in Date Range

```{r}
renderPlotly({
  
  p3 <- cs()$interval_covid_data %>%
    ggplot(aes(date, total_active)) +
    geom_col(fill = "#0f1955", alpha = 0.7) +
    theme_classic() +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(
      expand = c(0, 0),
      breaks = integer_breaks()
    ) +
    labs(x = "Date", y = "Active Cases") +
    scale_x_date(date_labels = "%Y/%m/%d")
  
  p3 %>% 
    ggplotly() %>% 
      rangeslider(.[["x"]][["layout"]][["xaxis"]][["range"]][1], .[["x"]][["layout"]][["xaxis"]][["range"]][2])
})
```

### New Deaths in Date Range

```{r}
renderPlotly({
  p4 <- cs()$interval_covid_data %>%
    ggplot(aes(date, new_deaths)) +
    geom_col(fill = "#104d56", alpha = 0.7) +
    theme_classic() +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(
      expand = c(0, 0),
      breaks = integer_breaks()
    ) +
    labs(x = "Date", y = "New Deaths") +
    scale_x_date(date_labels = "%Y/%m/%d")
  
  p4 %>% 
    ggplotly() %>% 
      rangeslider(.[["x"]][["layout"]][["xaxis"]][["range"]][1], .[["x"]][["layout"]][["xaxis"]][["range"]][2])
  
})
```


### New Tests in Date Range

```{r}
renderPlotly({
  p5 <- cs()$interval_covid_data %>%
    ggplot(aes(date, new_tests)) +
    geom_col(fill = "#bf8cff", alpha = 0.7) +
    theme_classic() +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(
      expand = c(0, 0),
      breaks = integer_breaks()
    ) +
    labs(x = "Date", y = "New Tests") +
    scale_x_date(date_labels = "%Y/%m/%d")
  
  p5 %>% 
    ggplotly() %>% 
      rangeslider(.[["x"]][["layout"]][["xaxis"]][["range"]][1], .[["x"]][["layout"]][["xaxis"]][["range"]][2])
})
```


### Positive Rate in Date Range

```{r}
renderPlotly({
  p6 <- cs()$interval_covid_data %>%
    ggplot(aes(date, positive_rate)) +
    geom_line(color = "#368fce", alpha = 0.7) +
    theme_classic() +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(
      expand = c(0, 0),
      labels = scales::percent_format()
    ) +
    labs(x = "Date", y = "Positive Rate") +
    scale_x_date(date_labels = "%Y/%m/%d")
  
  p6 %>% 
    ggplotly() %>% 
      rangeslider(.[["x"]][["layout"]][["xaxis"]][["range"]][1], .[["x"]][["layout"]][["xaxis"]][["range"]][2])
})
```


Column {data-width=120}
-----------------------------------------------------------------------

### $\,$

```{r}
renderValueBox({
  cs <- cs()


  valueBox(
    value = prettyNum(cs$new_cases, big.mark = ","),
    caption = paste0("New cases in ", input$date_range_country[2]),
    color = "#36479C",
    icon = "fa-viruses"
  )
})
```

### $\,$

```{r}
renderValueBox({
  cs <- cs()


  valueBox(
    value = prettyNum(cs$active_cases, big.mark = ","),
    caption = paste0("Active cases in ", input$date_range_country[2]),
    color = "#36479C"
  ) # ,
  # icon = 'fo-virus')
})
```

### $\,$

```{r}
renderValueBox({
  cs <- cs()


  valueBox(
    value = prettyNum(cs$cases_pm, big.mark = ","),
    caption = paste0("Total cases per million in Date Range"),
    color = "#36479C"
  ) # ,
  # icon = 'fo-virus')
})
```


### $\,$

```{r}
renderValueBox({
  cs <- cs()


  valueBox(
    value = prettyNum(cs$total_recovered, big.mark = ","),
    caption = paste0("Total recovered in ", input$date_range_country[2]),
    color = "#36479C"
  ) # ,
  # icon = 'fo-virus')
})
```

### $\,$

```{r}
renderValueBox({
  cs <- cs()


  valueBox(
    value = prettyNum(cs$total_cases, big.mark = ","),
    caption = paste0("Total cases in Data Range"),
    color = "#36479C"
  ) # ,
  # icon = 'fo-virus')
})
```


### $\,$

```{r}
renderValueBox({
  cs <- cs()


  valueBox(
    value = prettyNum(cs$last_day_deaths, big.mark = ","),
    caption = paste0("New deaths in ", input$date_range_country[2]),
    color = "#36479C"
  ) # ,
  # icon = 'fo-virus')
})
```

### $\,$

```{r}
renderValueBox({
  cs <- cs()


  valueBox(
    value = prettyNum(cs$total_death, big.mark = ","),
    caption = paste0("Total deaths in Date Range"),
    color = "#36479C"
  ) # ,
  # icon = 'fa-virus')
})
```


### $\,$

```{r}
renderValueBox({
  cs <- cs()


  valueBox(
    value = prettyNum(cs$total_test, big.mark = ","),
    caption = paste0("Total tests in Date Range"),
    color = "#8ec3a7"
  ) # ,
  # icon = 'fo-virus')
})
```

### $\,$

```{r}
renderValueBox({
  cs <- cs()


  valueBox(
    value = ifelse(is.infinite(cs$total_positivity),
      "No data",
      paste0(cs$total_positivity, "%")
    ),
    caption = paste0("Positive rate in Date Range"),
    color = "#8ec3a7"
  ) # ,
  # icon = 'fo-virus')
})
```

### $\,$

```{r}
renderValueBox({
  cs <- cs()


  valueBox(
    value = prettyNum(cs$test_last_day, big.mark = ","),
    caption = paste0("New tests in ", input$date_range_country[2]),
    color = "#8ec3a7"
  ) # ,
  # icon = 'fo-virus')
})
```

### $\,$

```{r}
renderValueBox({
  cs <- cs()


  valueBox(
    value = ifelse(is.infinite(cs$positivity_last_day),
      "No data",
      paste0(cs$positivity_last_day, "%")
    ),
    caption = paste0("Positive rate in ", input$date_range_country[2]),
    color = "#8ec3a7"
  ) # ,
  # icon = 'fo-virus')
})
```
